
## Clear environment, if needed
rm(list = ls())
setwd("/Users/irmasirutyte/Desktop/VAM Bulgaria")

## Libraries
library(robotoolbox) # This loads koboloadeR package
library(haven)
library(tidyverse)
library(readxl)
library(srvyr)
library(ggplot2)
library(robotoolbox)
library(labelled)
library(remotes)
library(dm)
library(janitor)
library(dplyr)
library(DiagrammeR)
library(Hmisc)
library(xlsx)
library(writexl)
library(expss)
library(unhcrthemes)
library(ggplot2)
library(openxlsx)



sheet_names = excel_sheets("Data/bulgaria_multi-sector_needs_assessment_2023_-_latest_version_-_false_-_2023-11-10-08-12-23.xlsx") # get sheet names
sheet_names # print sheet names

# Read Sheet 1
df_hh <- read_excel("Data/bulgaria_multi-sector_needs_assessment_2023_-_latest_version_-_false_-_2023-11-10-08-12-23.xlsx", sheet = "Bulgaria Multi-Sector Needs ...")
View(df_hh)


df_hh <- df_hh %>%
  rename("index" = "_index")

# Read Sheet 2
df_ind <- read_excel("Data/bulgaria_multi-sector_needs_assessment_2023_-_latest_version_-_false_-_2023-11-10-08-12-23.xlsx", sheet = "Info")

df_ind <- df_ind %>%
  rename("parent_index" = "_parent_index")


#---------------------------------------------------------------
#---------------------------------------------------------------

setwd("/Users/irmasirutyte/Desktop")


# IMPORT THE INDICATORS 

df_hh_indicators_bulgaria <- read_excel("MSNA Composite/MSNA_updated_Bulgaria/Combined/household_combined_indicators_bulgaria.xlsx")
df_ind_indicators_bulgaria <- read_excel("MSNA Composite/MSNA_updated_Bulgaria/Combined/individual_combined_indicators_bulgaria.xlsx")

setwd("/Users/irmasirutyte/Desktop/VAM Bulgaria")

view(df_hh_indicators_bulgaria)
view(df_ind_indicators_bulgaria)

# Rename _index to index in df_hh_slovakia_msna
df_hh_indicators_bulgaria <- df_hh_indicators_bulgaria %>% rename(index = "_index")


# Select the columns you want to keep in df_hh
df_hh_indicators_bulgaria <- df_hh_indicators_bulgaria %>%
  select(-DR7.2_SS_RESP_GEN,-DR7.3_NUM_RESP_AGE )  # Specify the variables to remove


# Merge the datasets 
df_hh <- left_join(df_hh, df_hh_indicators_bulgaria, by = "index")

view(df_hh)


#---------------------------------------------------------------
# Economic Capacity to Meet Essential Needs (ECMEN) ------------
# ---------------------------------------------------------------
# WFP-VAM/Resources https://resources.vam.wfp.org/data-analysis/quantitative/essential-needs/economic-capacity-to-meet-essential-needs-ecmen
# Calculation: 1. Identify the relevant MEB: From Yigit in Romania CO --> Threshold of absolute poverty	2285.2; Threshold of extreme poverty	1843.0
#              2. Aggregate consumption expenditures to establish household economic capacity
#              3. Compare the economic capacity of each household against the MEB to establish whether a household is above this threshold, i.e. whether it can meet its essential needs.
#              4. Produce the ECMEN indicator by calculating the percentage of households whose economic capacity falls above the MEB threshold. 

# Note 1: In the version used for assessment: a) the household economic capacity aggregate should not include the value of consumed in-kind assistance gifts; b) the value of the cash assistance received from the humanitarian sector should be deducted from the household economic capacity aggregate (but only for the estimated share of the cash assistance that is used for consumption, when available).



# ------------------------------------------------------------------------------
# EXPENDITURE
# ------------------------------------------------------------------------------

# SE.2.1_NUM_FOOD - monthly
# SE.2.2_NUM_ACCOM - monthly
# SE.2.4_NUM_HYG - monthly
# SE.2.5_NUM_COMM - monthly
# SE.2.6_NUM_HH_BILL - monthly
# SE.2.3_NUM_HLTH - monthly
# SE.2.8_NUM_HLTH_6_MTH  -  6 months 
# SE.2.10_NUM_EDU - 12 months 
# SE.2.9_NUM_DEBT - 6 months
# SE.2.7_NUM_OTH - monthly
# 9 categories in total

# Specify the list of variables
variables_to_replace <- c(
  "SE.2.1_NUM_FOOD",
  "SE.2.2_NUM_ACCOM",
  "SE.2.3_NUM_HLTH",
  "SE.2.4_NUM_HYG",
  "SE.2.5_NUM_COMM",
  "SE.2.6_NUM_HH_BILL",
  "SE.2.7_NUM_OTH",

  "SE.2.8_NUM_HLTH_6_MTH",
  "SE.2.10_NUM_EDU",
  "SE.2.9_NUM_DEBT"
 
)

# Loop through the variables and replace 9999 or 99999 with NA
for (var in variables_to_replace) {
  df_hh[[var]] <- ifelse(df_hh[[var]] %in% c(999, 9999, 99999,8888), NA, df_hh[[var]])
}


# REMOVE OUTLIERS THAT ARE LESS THAN 10 AND HIGHER THAN 5000
for (variable_name in variables_to_replace) {
  df_hh[[variable_name]] <- ifelse(df_hh[[variable_name]] < 10 | df_hh[[variable_name]] > 10000, NA, df_hh[[variable_name]])
}



################################################################################
################################################################################


# HEALTHCARE EXPENDITURE 6 MONTHS - CONVERT TO 1 MONTH

# df_hh$SE.2.8_NUM_HLTH_6_MTH  <- as.numeric(df_hh$SE.2.0_NUM_HH_EXP)
df_hh$SE.2.8_NUM_HLTH_1_MTH  <- round(df_hh$SE.2.8_NUM_HLTH_6_MTH  / 6, 2)

# DEBT EXPENDITURE 6 MONTHS - CONVERT TO 1 MONTH
df_hh$SE.2.9_NUM_DEBT_1_MTH  <- round(df_hh$SE.2.9_NUM_DEBT  / 6, 2)

# EDUCATION EXPENDITURE 12 MONTHS - CONVERT TO 1 MONTH
df_hh$SE.2.10_NUM_EDU_1_MTH  <- round(df_hh$SE.2.10_NUM_EDU  / 12, 2)

df_hh$health_expenditure = round(df_hh$SE.2.3_NUM_HLTH + df_hh$SE.2.8_NUM_HLTH_1_MTH,2)

# Drop these columns:  
df_hh <- df_hh[, !(names(df_hh) %in% c("SE.2.8_NUM_HLTH_1_MTH", "SE.2.3_NUM_HLTH"))]

df_hh <- df_hh %>%
  rename(
    HHExp_FoodItems_1M = SE.2.1_NUM_FOOD,
    HHExpNFRent_1M = SE.2.2_NUM_ACCOM,
    HHExpNFHyg_1M = SE.2.4_NUM_HYG,
    HHExpNFUtil_1M = SE.2.6_NUM_HH_BILL,
    HHExpNFPhone_1M = SE.2.5_NUM_COMM,
    HHExpNFMedServ_1M = health_expenditure,
    HHExpNFEdu_1M = SE.2.10_NUM_EDU_1_MTH,
    HHExpNFDebt_1M = SE.2.9_NUM_DEBT_1_MTH, 
    HHExpNFOther_1M = SE.2.7_NUM_OTH
  ) %>%
  group_by(DR8_NUM_HH_SIZE) %>%
  mutate(
    HHExp_FoodItems_1M_median = ifelse(is.na(HHExp_FoodItems_1M), median(HHExp_FoodItems_1M, na.rm = TRUE), HHExp_FoodItems_1M),
    HHExpNFRent_1M_median = ifelse(is.na(HHExpNFRent_1M), median(HHExpNFRent_1M, na.rm = TRUE), HHExpNFRent_1M),
    HHExpNFHyg_1M_median = ifelse(is.na(HHExpNFHyg_1M), median(HHExpNFHyg_1M, na.rm = TRUE), HHExpNFHyg_1M),
    HHExpNFUtil_1M_median = ifelse(is.na(HHExpNFUtil_1M), median(HHExpNFUtil_1M, na.rm = TRUE), HHExpNFUtil_1M),
    HHExpNFPhone_1M_median = ifelse(is.na(HHExpNFPhone_1M), median(HHExpNFPhone_1M, na.rm = TRUE), HHExpNFPhone_1M),
    HHExpNFMedServ_1M_median = ifelse(is.na(HHExpNFMedServ_1M), median(HHExpNFMedServ_1M, na.rm = TRUE), HHExpNFMedServ_1M),
    HHExpNFEdu_1M_median = ifelse(is.na(HHExpNFEdu_1M), median(HHExpNFEdu_1M, na.rm = TRUE), HHExpNFEdu_1M),
    HHExpNFDebt_1M_median = ifelse(is.na(HHExpNFDebt_1M), median(HHExpNFDebt_1M, na.rm = TRUE), HHExpNFDebt_1M),
    HHExpNFOther_1M_median = ifelse(is.na(HHExpNFOther_1M), median(HHExpNFOther_1M, na.rm = TRUE), HHExpNFOther_1M)
  ) %>%
  ungroup()


# Add labels to the renamed columns
label(df_hh$HHExp_FoodItems_1M) <- "Expenditures on Food Items (1-Month)"
label(df_hh$HHExpNFRent_1M) <- "Expenditures on rent (1-Month)"
label(df_hh$HHExpNFHyg_1M) <- "Expenditures on non-food household items for regular purchase (hygiene, etc.) (1-Month)"
label(df_hh$HHExpNFUtil_1M) <- "Expenditures on utilities (electricity or gas connection, etc.) (1-Month)"
label(df_hh$HHExpNFPhone_1M) <- "Expenditures on communication (1-Month)"
label(df_hh$HHExpNFEdu_1M) <- "Expenditures on education costs (1-Month)"
label(df_hh$HHExpNFMedServ_1M) <- "Expenditures on health-related costs (1-Month)"
label(df_hh$HHExpNFDebt_1M) <- "Expenditures on debt (1-month)"
label(df_hh$HHExpNFOther_1M) <- "Expenditure on all other frequent expenditures (1-Month)"


# 3. Calculate household economic capacity
# Note: Remember that for the version of ECMEN used for assessments (excluding assistance), the value of consumed in-kind assistance and gifts should be excluded from the household economic capacity aggregate
# In our case we do not have information regarding the assistance used for consumption
# Also, no information on consumption of food from own-production 

# Select the columns you want to sum
columns_to_sum_median <- c(
  "HHExp_FoodItems_1M_median", "HHExpNFRent_1M_median", "HHExpNFHyg_1M_median",
  "HHExpNFUtil_1M_median", "HHExpNFPhone_1M_median",  "HHExpNFMedServ_1M_median",
  "HHExpNFEdu_1M_median", "HHExpNFDebt_1M_median", "HHExpNFOther_1M_median"
)

# Use rowSums to sum the selected columns while ignoring missing values
df_hh$HHExpenditure_median <- round(rowSums(df_hh[columns_to_sum_median], na.rm = TRUE), 2)


# Select the columns you want to sum
columns_to_sum <- c(
  "HHExp_FoodItems_1M", "HHExpNFRent_1M", "HHExpNFHyg_1M",
  "HHExpNFUtil_1M", "HHExpNFPhone_1M",  "HHExpNFMedServ_1M",
  "HHExpNFEdu_1M", "HHExpNFDebt_1M", "HHExpNFOther_1M"
)

# Use rowSums to sum the selected columns while ignoring missing values
df_hh$HHExpenditure <- round(rowSums(df_hh[columns_to_sum], na.rm = TRUE), 2)


# Calculate the average
average <- mean(df_hh$HHExpenditure, na.rm = TRUE)

average_median <- mean(df_hh$HHExpenditure_median)

# Print the average
cat("The average is:", average) # equals 1014
cat("The average imputing median is:", average_median) # equals 1751 (significantly higher since a lot of missing values were in food, health, accommodation)


write.xlsx(df_hh, "expenditure.xlsx")


# Add a label to the newly created column
label(df_hh$HHExpenditure) <- "Household Economic Capacity - monthly"
label(df_hh$HHExpenditure_median) <- "Household Economic Capacity (median)"



### ----------------------------------------------------------------------------
### EXPENDITURE PER CAPITA
### ----------------------------------------------------------------------------

# 5.1 Compute household size
df_hh$HHSize <- df_hh$DR8_NUM_HH_SIZE

# 5.2 Calculate household economic capacity per capita
df_hh$PCExpenditure <- df_hh$HHExpenditure / df_hh$HHSize
average_PCExpenditure <- mean(df_hh$PCExpenditure, na.rm = TRUE)
cat("Average PCExpenditure:", average_PCExpenditure, "\n")


# 5.2 Calculate household economic capacity per capita imputed medians
df_hh$PCExpenditure_median <- df_hh$HHExpenditure_median / df_hh$HHSize
average_PCExpenditure_median <- mean(df_hh$PCExpenditure_median, na.rm = TRUE)
cat("Average PCExpenditure_median:", average_PCExpenditure_median , "\n")


# Add variable label
attr(df_hh$PCExpenditure, "label") <- "Household Economic Capacity per capita - monthly"  



### ------------------------------------------------------------------------------
### CALCULATE VARIABLES ON HOUSEHOLD LEVEL
### ------------------------------------------------------------------------------

# 1 adult member = 1438
# second adult member = 719
# child below 14 = 431


df_ind <- df_ind %>%
  group_by(parent_index) %>%
  mutate(
    number_adults_above_14 = sum(DR.11_NUM_AGE >= 14),
    number_children_below_14 = sum(DR.11_NUM_AGE < 14),
    number_order_persons_above_60 = sum(DR.11_NUM_AGE >= 60),
  ) %>%
  ungroup()


df_ind_meb <- df_ind %>%
  select("parent_index", "number_adults_above_14","number_children_below_14","number_order_persons_above_60") 

# Create a temporary dataset with unique parent_index rows from df_ind_meb
unique_df_ind_meb <- df_ind_meb %>%
  distinct(parent_index, .keep_all = TRUE)


df_hh <- df_hh %>%
  left_join(unique_df_ind_meb, by = c("index" = "parent_index"))



# 3 Potential thresholds for MEB calculation
# Poverty line per person per month = 526 BGN 
# Minimum wage = 933 BGN
# Living wage = 1438 BGN 


# We have decided to use minimum wage since it's in between poverty line and living wage 

df_hh$family_meb = (933 * 1.0) + (933 * 0.5 * (df_hh$number_adults_above_14 - 1)) + (933 * 0.3 * df_hh$number_children_below_14)



################################################################################

df_hh$family_smeb = df_hh$family_meb * 0.7

# Create a new variable indicating economic capacity relative to MEB/SMEB
df_hh$HHExp_ECMEN_2 <- ifelse(df_hh$total_expenditure > df_hh$family_meb, 1,
                            ifelse(df_hh$total_expenditure > df_hh$family_smeb & df_hh$total_expenditure <= df_hh$family_meb, 2,
                                   ifelse(df_hh$total_expenditure <= df_hh$family_smeb & !is.na(df_hh$total_expenditure), 3, NA)))



# Add variable label
attr(df_hh$HHExp_ECMEN_2, "label") <- "ECMEN Scenario 2"

# Define value labels
value_labels <- c("1 - Above MEB", 
                  "2 - Between MEB & SMEB", 
                  "3 - Below SMEB")

# Apply value labels
df_hh$HHExp_ECMEN_2 <- factor(df_hh$HHExp_ECMEN_2, levels = 1:3, labels = value_labels)

# Display table
table(df_hh$HHExp_ECMEN_2)


# ------------------------------------------------------------------------------
# COMBINE VARIABLES
# Proportion of PoC with access to health services
# ------------------------------------------------------------------------------
# Check the class and unique values of Max_coping_behaviourEN
class(df_hh$Max_coping_behaviourEN)
unique(df_hh$Max_coping_behaviourEN)

# Convert Max_coping_behaviourEN to factor
df_hh$Max_coping_behaviourEN <- as.factor(df_hh$Max_coping_behaviourEN)

# Combine categories 1 and 2 in NCS to create 3 categories
df_hh$NCS_3cat <- NA  # Create a new variable

df_hh$NCS_3cat[df_hh$Max_coping_behaviourEN %in% c("HH not adopting coping strategies", "Stress coping strategies")] <- 1  # No coping/stressed
df_hh$NCS_3cat[df_hh$Max_coping_behaviourEN == "Crisis coping strategies"] <- 2  # Crisis
df_hh$NCS_3cat[df_hh$Max_coping_behaviourEN == "Emergencies coping strategies"] <- 3  # Emergency

# Convert NCS_3cat to factor and add value labels
df_hh$NCS_3cat <- as.factor(df_hh$NCS_3cat)
levels(df_hh$NCS_3cat) <- c("No coping/stressed", "Crisis", "Emergency")

# Add variable label
attr(df_hh$NCS_3cat, "label") <- "NCS 3 categories"

# Check the frequency table
table(df_hh$NCS_3cat)


#-----------------------------------------------
# 1. Combined FCS, LCSI & ECMEN --------------
#-----------------------------------------------

# NCS_3CAT - Livelihood coping strategies
# 1  -  No coping/stressed
# 2  -  Crisis
# 3  -  Emergency

# FCSCat28- Food consumption score
# 1 - Poor
# 2 - Borderline
# 3 - Acceptable

# ECMEN - Economic capacity to meet basic needs
# 1 - Above MEB (minimum expenditure basket)
# 2 - Between MEB & SMEB (between minimum expenditure basket, and survival minimum expenditure basket)
# 3 - Below SMEB (survival minimum expenditure basket)

# SAME AS PREVIOUS APPROACH - ONLY USE 70% OF MEB AS SMEB (SAME SHARE AS IN MOLDOVA)


table(df_hh$FCSCat28)
table(df_hh$NCS_3cat)
table(df_hh$HHExp_ECMEN_2)


# Define conditions and assign values with character labels
df_hh$Vulnerability_fcs_ncs_ecmen_4cat_2[(
  (df_hh$HHExp_ECMEN_2 == "3 - Below SMEB" & df_hh$NCS_3cat == "Emergency" & df_hh$FCSCat28 %in% c("Poor", "Borderline", "Acceptable")) |
    (df_hh$HHExp_ECMEN_2 == "3 - Below SMEB" & df_hh$NCS_3cat %in% c("No coping/stressed", "Crisis", "Emergency") & df_hh$FCSCat28 == "Poor") |
    (df_hh$HHExp_ECMEN_2 %in% c("1 - Above MEB", "2 - Between MEB & SMEB", "3 - Below SMEB") & df_hh$NCS_3cat == "Emergency" & df_hh$FCSCat28 == "Poor")
)] <- 1 # Extremely vulnerable

df_hh$Vulnerability_fcs_ncs_ecmen_4cat_2[(
  (df_hh$HHExp_ECMEN_2 == "3 - Below SMEB" & df_hh$NCS_3cat %in% c("No coping/stressed", "Crisis") & df_hh$FCSCat28 %in% c("Acceptable", "Borderline")) |
    (df_hh$HHExp_ECMEN_2 %in% c("1 - Above MEB", "2 - Between MEB & SMEB") & df_hh$NCS_3cat == "Emergency" & df_hh$FCSCat28 %in% c("Acceptable", "Borderline")) |
    (df_hh$HHExp_ECMEN_2 %in% c("1 - Above MEB", "2 - Between MEB & SMEB") & df_hh$NCS_3cat %in% c("No coping/stressed", "Crisis") & df_hh$FCSCat28 == "Poor")
)] <- 2 # Highly vulnerable

df_hh$Vulnerability_fcs_ncs_ecmen_4cat_2[(
  (df_hh$HHExp_ECMEN_2 == "2 - Between MEB & SMEB" & df_hh$NCS_3cat %in% c("No coping/stressed", "Crisis") & df_hh$FCSCat28 %in% c("Acceptable", "Borderline")) |
    (df_hh$HHExp_ECMEN_2 %in% c("1 - Above MEB", "2 - Between MEB & SMEB") & df_hh$NCS_3cat == "Crisis" & df_hh$FCSCat28 %in% c("Acceptable", "Borderline")) |
    (df_hh$HHExp_ECMEN_2 %in% c("1 - Above MEB", "2 - Between MEB & SMEB") & df_hh$NCS_3cat %in% c("No coping/stressed", "Crisis") & df_hh$FCSCat28 == "Borderline")
)] <- 3 # Moderately vulnerable

df_hh$Vulnerability_fcs_ncs_ecmen_4cat_2[(
  df_hh$HHExp_ECMEN_2 == "1 - Above MEB" & df_hh$NCS_3cat == "No coping/stressed" & df_hh$FCSCat28 == "Acceptable"
)] <- 4 # Not vulnerable

# Check the frequency table
table(df_hh$Vulnerability_fcs_ncs_ecmen_4cat_2)


# Define conditions and assign values for a dependent variable (should be 1 or 0, the 2 will be removed later on)
df_hh <- df_hh %>% mutate(vulnerability_log_2 = case_when(
  df_hh$Vulnerability_fcs_ncs_ecmen_4cat_2 == 1 | df_hh$Vulnerability_fcs_ncs_ecmen_4cat_2 == 2 ~ 1 , # Extremely or highly vulnerable
  df_hh$Vulnerability_fcs_ncs_ecmen_4cat_2 == 3 | df_hh$Vulnerability_fcs_ncs_ecmen_4cat_2 == 4 ~ 0, # Moderately vulnerable or not vulnerable
  TRUE ~ 2))


table(df_hh$vulnerability_log_2)


# Add variable label
attr(df_hh$Vulnerability_fcs_ncs_ecmen_4cat_2, "label") <- "Vulnerability Tier Classification (FCS, NCS & ECMEN)"

# Define value labels
value_labels_2 <- c("Extremely vulnerable", "Highly vulnerable","Moderately vulnerable", "Not vulnerable")

# Apply value labels
df_hh$Vulnerability_fcs_ncs_ecmen_4cat_2 <- factor(df_hh$Vulnerability_fcs_ncs_ecmen_4cat_2, levels = 1:4, labels = value_labels_2)


################################################################################
#### - CALCULATE INCOME
################################################################################


# Select all income-related columns
columns_all_income <- c(
  "SE2.11a_NUM_INC_AMT_RGL", "SE2.11a_NUM_INC_AMT_CAS", "SE2.11a_NUM_INC_AMT_SLF", "SE2.11a_NUM_INC_AMT_OTH",
  "SE2.11b_NUM_BEN_AMT_CSH", "SE2.11b_NUM_BEN_AMT_DSB", "SE2.11b_NUM_BEN_AMT_UNE", "SE2.11b_NUM_BEN_AMT_CFG", "SE2.11b_NUM_BEN_AMT_OTH",
  "SE2.11d_NUM_BEN_OTH_CSH", "SE2.11d_NUM_BEN_OTH_INV", "SE2.11d_NUM_BEN_OTH_LON", "SE2.11d_NUM_BEN_OTH_REL_UKR","SE2.11d_NUM_BEN_OTH_REL_OUT_UKR","SE2.11d_NUM_BEN_OTH_OTH"	
)


# Loop through the variables and replace 9999 or 99999 with NA
for (var in columns_all_income) {
  df_hh[[var]] <- ifelse(df_hh[[var]] %in% c(9999, 99999,8888,9998), NA, df_hh[[var]])
}

# Use rowSums to sum all the selected columns while ignoring missing values
df_hh$total_income_sum <- round(rowSums(df_hh[, columns_all_income], na.rm = TRUE), 2)

# Calculate the average
average_total_income <- mean(df_hh$total_income_sum, na.rm = TRUE)

# Print the average
print(average_total_income)

# Calculate the Pearson correlation coefficient
correlation_coefficient <- cor(df_hh$total_income_sum, df_hh$HHExpenditure)
# Print the result
cat("Pearson correlation coefficient:", correlation_coefficient, "\n")



################################################################################
####   VARIABLE PREPARATION
################################################################################

################################################################################
###    DEMOGRAPHICS 

# income sources - check additional income sources 
names(df_hh)[names(df_hh) == "DR8_NUM_HH_SIZE"] <- "hh_size" # INCLUDE

table(df_hh$hh_size)


names(df_hh)[names(df_hh) == "DR10_NUM_PREG_BF"] <- "dummy_pregnant_breastfeeding" # INCLUDE

table(df_hh$hh_size)

table(df_hh$dummy_pregnant_breastfeeding)



# dummy child not attending school
df_hh <- df_hh %>%
  mutate(dummy_pregnant_breastfeeding = case_when(
    df_hh$dummy_pregnant_breastfeeding > 0 ~ 1, 
    TRUE ~ 0
  ))

################################################################################
### Accommodation type and living conditions

# Recode living conditions
names(df_hh)[names(df_hh) == "SHL07_SM_LIV_COND"] <- "living_conditions_issues" 
df_hh <- df_hh %>%
  mutate(living_conditions_issues = case_when(
    living_conditions_issues == "no_issues" ~ 0,
    TRUE ~ 1  # else assign that it has issues
  ))

table(df_hh$living_conditions_issues) # INLCUDE - 133 RESPONDENTS REPORTED HAVING SOME ISSUES (SAMPLE LOW BUT POSSIBLE TO INCLUDE)


names(df_hh)[names(df_hh) == "SHL08.1_SS_HEATING"] <- "house_heating"
table(df_hh$house_heating) # EXCLUDE - most people answered yes, only 15 respondents said NO

names(df_hh)[names(df_hh) == "PRT06_SS_SAFETY_LVL"] <-  "safety_neighbourhood"
table(df_hh$safety_neighbourhood) # EXCLUDE - (INSTEAD INCLUDE RMS INDICATOR)

names(df_hh)[names(df_hh) == "L12_SS_HV_BNK_ACC"] <- "owns_bank_account" 
table(df_hh$owns_bank_account) # EXCLUDE
table(df_hh$outcome13_1_bank_account) # INCLUDE BECAUSE IT'S BETTER TO HAVE 2 GROUPS FOR REGRESSION


names(df_hh)[names(df_hh) == "SHL01_SS_ACCOM_TYP"] <- "accommodation_type"

table(df_hh$accommodation_type)



df_hh <- df_hh %>%
  mutate(accommodation_type = case_when(
    accommodation_type == "prefer_not_to_answer" ~ "other",
    accommodation_type == "shared_accommodation" ~ "other",
    accommodation_type == "hotel_hostel" ~ "state_programme",
    accommodation_type == "collective_site" ~ "state_programme",
    TRUE ~ as.character(accommodation_type)  # Keep other values unchanged
  ))

table(df_hh$accommodation_type)


names(df_hh)[names(df_hh) == "SHL01.1_SS_ACCOM_ARR"] <- "accommodation_arrangement"
table(df_hh$accommodation_arrangement)



df_hh <- df_hh %>%
  mutate(accommodation_arrangement = case_when(
    accommodation_arrangement == "do_not_know" ~ "other",
    accommodation_arrangement == "prefer_not_to_answer" ~ "other",
    accommodation_arrangement == "full_payment_by_household" ~ "full_payment_by_household",
    accommodation_arrangement == "no_payment_free_government" ~ "no_payment_free",
    accommodation_arrangement == "no_payment_free_hosted" ~ "no_payment_free",
    accommodation_arrangement == "partial_payment_by_household" ~ "partial_payment_by_household",
    accommodation_arrangement == "partial_payment_hosted" ~ "partial_payment_by_household",
    accommodation_arrangement == "subsidized_by_employer" ~ "partial_payment_by_household",
    TRUE ~ as.character(accommodation_arrangement)  # Keep other values unchanged
  ))

table(df_hh$accommodation_arrangement)

# Recode "DoNotKnow" to "PreferNotAnswer" as NO to create dummy variation

names(df_hh)[names(df_hh) == "SHL01.2_SS_URB_RURAL"] <- "rural_urban"  # INCLUDE


df_hh <- df_hh %>%
  mutate(rural_urban = case_when(
    rural_urban == "do_not_know" ~ "urban", # assigning value to most common category
    TRUE ~ rural_urban  # Keep other values unchanged
  ))
table(df_hh$rural_urban)


table(df_hh$SHL06_SS_UND_PRESSURE) # EXCLUDE --- BECAUSE ONLY 19 PEOPLE REPORTED PRESSURE
table(df_hh$SHL04) # EXCLUDE --- rent paid on time? ONLY ABOUT 20% SAMPLE ANSWER THIS QUESTION AND ONLY 11 RESPONDENT INDICATED THAT THEY PAID LATE


# TEMPORARY PROTECTION 
names(df_hh)[names(df_hh) == "PRT02_SS_TEMP_PROT"] <-  "temp_protection_application"
table(df_hh$temp_protection_application)
table(df_hh$ind_temp_prot) # REMOVE THE SAMPLE IN THE NO (only 27 respondents) CATEGORY IS TOO LOW


# LOCAL HOSTILITY
names(df_hh)[names(df_hh) == "SC3_SS_EXP_HOSTILE"] <-  "local_hostility"

table(df_hh$local_hostility)


# Recode "DoNotKnow" to "PreferNotAnswer" as NO to create dummy variation
df_hh <- df_hh %>%
  mutate(local_hostility = case_when(
    local_hostility == "DoNotKnow" ~ "missing", 
    local_hostility == "PreferNotAnswer" ~ "missing",
    TRUE ~ local_hostility  # Keep other values unchanged
  ))

table(df_hh$local_hostility)


# PRIORITY NEEDS
names(df_hh)[names(df_hh) == "AAP.5_SM_TOP_NEEDS_no_needs"] <- "priority_need_none"
names(df_hh)[names(df_hh) == "AAP.5_SM_TOP_NEEDS_accommodation"] <- "priority_need_accommodation"
names(df_hh)[names(df_hh) == "AAP.5_SM_TOP_NEEDS_employment_livelihoods"] <- "priority_need_employment"
names(df_hh)[names(df_hh) == "AAP.5_SM_TOP_NEEDS_food"] <- "priority_need_food"
names(df_hh)[names(df_hh) == "AAP.5_SM_TOP_NEEDS_healthcare_services"] <- "priority_need_healthcare"
names(df_hh)[names(df_hh) == "AAP.5_SM_TOP_NEEDS_language_courses"] <- "priority_need_language_courses"
names(df_hh)[names(df_hh) == "AAP.5_SM_TOP_NEEDS_child_care_support"] <- "priority_need_childcare"
names(df_hh)[names(df_hh) == "AAP.5_SM_TOP_NEEDS_medicines"] <- "priority_need_medicines"


# INCOME SOURCES 
names(df_hh)[names(df_hh) == "SE2.11_SS_INC_SOR_no_income"] <- "income_source_none"

names(df_hh)[names(df_hh) == "SE2.11_SS_INC_SOR_social_protection_host_govt"] <- "income_source_soc_protection_host"
table(df_hh$income_source_soc_protection_host)

names(df_hh)[names(df_hh) == "SE2.11_SS_INC_SOR_social_protection_ukr_govt"] <- "income_source_soc_protection_ukr"
table(df_hh$income_source_soc_protection_ukr)

df_hh$social_protection <- ifelse(df_hh$income_source_soc_protection_host == 1 | df_hh$income_source_soc_protection_ukr == 1, 1, 0)
table(df_hh$social_protection)


names(df_hh)[names(df_hh) == "SE2.11_SS_INC_SOR_employment_host_country"] <- "income_source_employement_host"


# ACCOMMOTION 
names(df_hh)[names(df_hh) == "SHL05_SS_DUR_STAY"] <- "accommodation_duration"
table(df_hh$accommodation_duration)


df_hh <- df_hh %>%
  mutate(accommodation_duration = case_when(
    accommodation_duration  == "3_6_months" ~ "less_than_6_months", 
    accommodation_duration == "for_2_3_months" ~ "less_than_6_months",
    accommodation_duration == "for_the_coming_week" ~ "less_than_6_months",
    accommodation_duration == "for_up_to_1_month" ~ "less_than_6_months",
    accommodation_duration == "prefer_not_to_answer" ~ "less_than_6_months", # assign it as median - to the most common category 
    TRUE ~ accommodation_duration  # Keep other values unchanged
  ))

table(df_hh$accommodation_duration)


names(df_hh)[names(df_hh) == "DR7_SS_HH"] <- "household_head"
table(df_hh$household_head)


df_hh <- df_hh %>%
  mutate(household_head = case_when(
    household_head == "other" ~ "single", 
    household_head == "single-headed_household" ~ "single", 
    household_head == "yes,_head_or_cohead_of_household" ~ "cohead", 
    TRUE ~ household_head # Keep other values unchanged
  ))


table(df_hh$household_head)


################################################################################
# INDIVIDUAL LEVEL INDICATORS AGGREGATED TO HOUSEHOLD LEVEL
################################################################################

# Children not attending school


df_ind <- df_ind %>%
  mutate(tag_child_not_attending_school = case_when(
    E1_SS_ATT_EDU == "no" ~ 1, 
    TRUE ~ 0
  ))

table(df_ind$tag_child_not_attending_school)

df_ind <- df_ind %>%
  group_by(parent_index) %>%
  mutate(sum_number_children_not_attending_school = sum(tag_child_not_attending_school))


view(df_ind)


################################################################################
# Single - female household head


df_ind <- df_ind %>%
  mutate(tag_household_head = case_when(
    DR.13_SS_REL == "Head" ~ 1, 
    TRUE ~ 0
  ))

df_ind <- df_ind %>%
  group_by(parent_index) %>%
  mutate(sum_household_heads = sum(tag_household_head))

df_ind <- df_ind %>%
  mutate(tag_household_head_female = case_when(
    DR.13_SS_REL == "Head" & female == 1 ~ 1,
    TRUE ~ 0  # Assign 0 for other cases
  ))


df_ind <- df_ind %>%
  group_by(parent_index) %>%
  mutate(sum_female_household_heads = sum(tag_household_head_female))



 ###############################################################################
 # At least one person with work contract in a household
 
 df_ind <- df_ind %>%
   mutate(adult_employment_contract = case_when(
     SE11_SS_CONTRACT == "written_contract" ~ 1, 
     TRUE ~ 0
   ))
 
 
 df_ind <- df_ind %>%
   group_by(parent_index) %>%
   mutate(sum_adults_employment_contract = sum(adult_employment_contract))


 
 ###############################################################################
 # At least one person unemployed in a household
 
 
 df_ind <- df_ind %>%
   mutate(tag_unemployed = case_when(
     SE8_SS_ACTIVITY == "status_unempl" ~ 1, 
     TRUE ~ 0
   ))

 
  
 df_ind <- df_ind %>%
   group_by(parent_index) %>%
   mutate(sum_unemployed = sum(tag_unemployed))
 

 
 ###############################################################################
 # At least one person employed in a household
 
 
 df_ind <- df_ind %>%
   mutate(tag_employed = case_when(
     SE2_SS_WORK == "yes" ~ 1, 
     TRUE ~ 0
   ))
 
 
 
 df_ind <- df_ind %>%
   group_by(parent_index) %>%
   mutate(sum_employed = sum(tag_employed))
 
 
 ###############################################################################
 # At least one person with psychological issues
 
 
 df_ind <- df_ind %>%
   mutate(tag_psychological_issues = case_when(
     H11_SS_PSY == "yes" ~ 1, 
     TRUE ~ 0
   ))

 df_ind <- df_ind %>%
   group_by(parent_index) %>%
   mutate(sum_psychological_issue = sum(tag_psychological_issues))
 
 
 ###############################################################################
 # At least one person with health issues
 
 
 df_ind <- df_ind %>%
   mutate(tag_health_issue = case_when(
     H1_SS_HLTH_PBLM == "yes" ~ 1, 
     TRUE ~ 0
   ))
 
 df_ind <- df_ind %>%
   group_by(parent_index) %>%
   mutate(sum_health_issues = sum(tag_health_issue))
 
 
 ###############################################################################
 # At least one person with chronic illness
 
 
 df_ind <- df_ind %>%
   mutate(tag_chronic_illness = case_when(
     H2_SS_HLTH_CHRONIC_ILL == "yes" ~ 1, 
     TRUE ~ 0
   ))
 
 df_ind <- df_ind %>%
   group_by(parent_index) %>%
   mutate(sum_chronic_illness = sum(tag_chronic_illness))
 
 
 ###############################################################################
 # Average number of months since arrival in the same household 
 
 
 names(df_ind)[names(df_ind) == "DR.15_NUM_INHC"] <- "arrival_number_months"
 
 # Remove rows where 'DR.15_NUM_INHC' is equal to 999
 median_value <- median(df_ind$arrival_number_months, na.rm = TRUE)
 df_ind$arrival_number_months <- ifelse(df_ind$arrival_number_months == 999, median_value, df_ind$arrival_number_months)
 

#### SUMMARISING THIS DATA ON AN INDIVIDUAL LEVEL 

 df_selected <- df_ind %>%
   select(
     parent_index,
     sum_number_children_not_attending_school,
     sum_household_heads,
     sum_adults_employment_contract,
     sum_unemployed,
     sum_employed,
     arrival_number_months,
     sum_chronic_illness,
     sum_health_issues,
     sum_psychological_issue,
     sum_female_household_heads
   ) 
 
 view(df_selected)
 
 # Use aggregate to calculate means for each variable grouped by 'parent_index'
 df_hh_ind <- aggregate(. ~ parent_index, data = df_selected, FUN = mean, na.rm = TRUE, na.action = na.pass)
 
 
 # Assuming df_hh and df_hh_ind are your data frames
 df_hh <- left_join(df_hh, df_hh_ind, by = c("index" = "parent_index"))
 
 df_hh <- df_hh %>%
   mutate(arrival_number_months = ifelse(is.na(arrival_number_months),
                                         median(arrival_number_months, na.rm = TRUE),
                                         arrival_number_months))
 
 
 
 
 ###############################################################################
 ### GENERATE DUMMIES 
 ###############################################################################
 
 
 #sum_number_children_not_attending_school - DUMMY 
 #sum_adults_employment_contract - DUMMY
 #sum_employed - DUMMY 
 #sum_chronic_illness - DUMMY
 #sum_health_issues - DUMMY 
 #sum_psychological_issue - DUMMY
 
 # dummy child not attending school
 df_hh <- df_hh %>%
   mutate(child_not_attending_school = case_when(
     df_hh$sum_number_children_not_attending_school > 0 ~ "yes", 
     df_hh$sum_number_children_not_attending_school == 0 ~ "no", 
     TRUE ~ "missing"
   ))
 
 # dummy employment contract
 df_hh <- df_hh %>%
   mutate(dummy_adult_employment_contract = case_when(
     df_hh$sum_adults_employment_contract > 0 ~ 1, 
     TRUE ~ 0
   )) 
 
 # dummy employment 
 df_hh <- df_hh %>%
   mutate(dummy_adult_employed = case_when(
     df_hh$sum_employed > 0 ~ 1, 
     TRUE ~ 0
   )) 
 
table(df_hh$dummy_adult_employed)


 # dummy chronic illness
 df_hh <- df_hh %>%
   mutate(dummy_chronic_illness = case_when(
     df_hh$sum_chronic_illness > 0 ~ 1, 
     TRUE ~ 0
   ))  
 
 # dummy health issues
 df_hh <- df_hh %>%
   mutate(dummy_health_issues = case_when(
     df_hh$sum_health_issues > 0 ~ 1, 
     TRUE ~ 0
   ))  
 
 # dummy pshychological issues
 df_hh <- df_hh %>%
   mutate(dummy_psychological_issue = case_when(
     df_hh$sum_psychological_issue > 0 ~ 1, 
     TRUE ~ 0
   ))  
 
 
 
 # generate single female tag 
 df_hh <- df_hh %>%
   mutate(dummy_single_female_head = case_when(
     df_hh$hh_size > 1 & df_hh$sum_female_household_heads >=1 ~ 1, 
     TRUE ~ 0
   ))
 
 
 # dummy older persons
 df_hh <- df_hh %>%
   mutate(dummy_older_persons = case_when(
     df_hh$number_order_persons_above_60 > 0 ~ 1, 
     TRUE ~ 0
   ))
 
 ###############################################################################
 ###    RESPONENT INFORMATION 
 ###############################################################################
 # find gender, age and education level of the head of the household
 

 # household level information 
 names(df_hh)[names(df_hh) == "DR7.2_SS_RESP_GEN"] <- "respondent_gender"
 names(df_hh)[names(df_hh) == "DR7.3_NUM_RESP_AGE"] <- "respondent_age"
 
 df_hh <- df_hh %>%
   mutate(respondent_gender = ifelse(respondent_gender == "prefer_not_to_answer", "female", respondent_gender)) 
 
 
 # individual level information - select respondent age, gender and education level 
 df_ind_filtered <- df_ind[df_ind$iteration_hh == 1, ]
 df_selected_variables <- df_ind_filtered[, c("parent_index", "DR.11_NUM_AGE", "DR.12_SS_GEN", "SE1_SS_EDU_LVL")]
 
 names(df_selected_variables)[names(df_selected_variables) == "SE1_SS_EDU_LVL"] <- "respondent_edu_level" 
 
 df_selected_variables <- df_selected_variables %>%
   mutate(respondent_edu_level = case_when(
     respondent_edu_level %in% c("master", "phd", "grand_phd", "PreferNotAnswer") ~ "Master and above",
     respondent_edu_level %in% c("no_edu", "pri_edu", "sec_edu") ~ "Lower education",
     TRUE ~ as.character(respondent_edu_level)
   ))
 
 
 table(df_selected_variables$respondent_edu_level)
 
 
 # Assuming df_hh and df_hh_ind are your data frames
 df_hh <- left_join(df_hh, df_selected_variables, by = c("index" = "parent_index"))
 
 
 ###############################################################################
 ###    HEAD OF HOUSEHOLD INFORMATION
 ###############################################################################
 # find gender, age and education level of the head of the household
 
 # Clean variable DR.13_SS_REL because we cannot have household head below 18, replace with other because we don't know the relationship  
 df_ind <- df_ind %>%
   mutate(DR.13_SS_REL = case_when(
     DR.13_SS_REL == "Head" & DR.11_NUM_AGE < 18 ~ "Other",
     TRUE ~ DR.13_SS_REL  # Keep the original value for other cases
   ))
 

 # Assuming df_ind is your data frame
 df_ind <- df_ind %>%
   mutate(education_level_number = case_when(
     SE1_SS_EDU_LVL == "grand_phd" ~ 8,
     SE1_SS_EDU_LVL == "phd" ~ 7,
     SE1_SS_EDU_LVL == "master" ~ 6,
     SE1_SS_EDU_LVL == "bachelor" ~ 5,
     SE1_SS_EDU_LVL == "tech" ~ 4,
     SE1_SS_EDU_LVL == "sec_edu" ~ 3,
     SE1_SS_EDU_LVL == "pri_edu" ~ 2,
     SE1_SS_EDU_LVL == "no_edu" ~ 1,
     SE1_SS_EDU_LVL == "PreferNotAnswer" ~ 6, # assign most common / median category
     TRUE ~ NA_integer_  # Assign NA for other cases
   ))
 
 
 
 result_df <- df_ind %>%
   select(parent_index, DR.13_SS_REL, DR.11_NUM_AGE, DR.12_SS_GEN, SE1_SS_EDU_LVL, education_level_number) %>%
   filter(DR.13_SS_REL == "Head") %>%
   arrange(parent_index, desc(education_level_number)) %>%
   group_by(parent_index) %>%
   slice(1) %>%
   ungroup()
 
 names(result_df)[names(result_df) == "DR.11_NUM_AGE"] <- "household_head_age"
 names(result_df)[names(result_df) == "DR.12_SS_GEN"] <- "household_head_gender"
 names(result_df)[names(result_df) == "SE1_SS_EDU_LVL"] <- "household_head_edu_level"
 names(result_df)[names(result_df) == "education_level_number"] <- "household_head_edu_level_number"
 
 
 result_df <- result_df %>%
   mutate(household_head_edu_level = case_when(
     household_head_edu_level %in% c("master", "phd", "grand_phd", "PreferNotAnswer") ~ "Master and above",
     household_head_edu_level %in% c("no_edu", "pri_edu", "sec_edu") ~ "Lower education",
     TRUE ~ as.character(household_head_edu_level)
   ))
 
 
 result_df <- subset(result_df, select = -DR.13_SS_REL)
 
 
 # merge the rows associated with the head of the household back to the household level dataset
 df_hh <- left_join(df_hh, result_df, by = c("index" = "parent_index"))
 
 
 ### WHERE HOUSEHOLD HEAD IS MISSING (23 households), insert respondent values (respondent proxy for the head of household)
 
 df_hh <- df_hh %>%
   mutate(household_head_edu_level = case_when(
     is.na(household_head_edu_level) ~ respondent_edu_level,
     TRUE ~ household_head_edu_level
   ))
 
 
 df_hh <- df_hh %>%
   mutate(household_head_gender = case_when(
     is.na(household_head_gender) ~ respondent_gender,
     household_head_gender == "other" ~ "female" , 
     TRUE ~ household_head_gender
   ))
 

 
 df_hh <- df_hh %>%
   mutate(household_head_age = case_when(
     is.na(household_head_age) ~ respondent_age,
     TRUE ~ household_head_age
   ))
 
 
 ###############################################################################
 ###      RMS INDICATORS 
 ###############################################################################
 
 # Replace values in all the RMS INDICATORS
 df_hh <- df_hh %>%
   mutate(
     impact3_3_safety_walking = case_when(
       impact3_3_safety_walking == 1 ~ "yes",
       impact3_3_safety_walking == 0 ~ "no",
       is.na(impact3_3_safety_walking) ~ "missing",
       TRUE ~ as.character(impact3_3_safety_walking)
     ),
     outcome4_1_GBV = case_when(
       outcome4_1_GBV == 1 ~ "yes",
       outcome4_1_GBV == 0 ~ "no",
       is.na(outcome4_1_GBV) ~ "missing",
       TRUE ~ as.character(outcome4_1_GBV)
     ),
     outcome13_1_bank_account = case_when(
       outcome13_1_bank_account == 1 ~ "yes",
       outcome13_1_bank_account == 0 ~ "no",
       is.na(outcome13_1_bank_account) ~ "missing",
       TRUE ~ as.character(outcome13_1_bank_account)
     ),
     outcome13_2_income = case_when(
       outcome13_2_income == 1 ~ "yes",
       outcome13_2_income == 0 ~ "no",
       is.na(outcome13_2_income) ~ "missing",
       TRUE ~ as.character(outcome13_2_income)
     ),
     outcome16_2_social_protection = case_when(
       outcome16_2_social_protection == 1 ~ "yes",
       outcome16_2_social_protection == 0 ~ "no",
       is.na(outcome16_2_social_protection) ~ "missing",
       TRUE ~ as.character(outcome16_2_social_protection)
     )
   )
 
 
write.xlsx(df_hh, "final_data_for_regression_3.xlsx")
 


# ------------------------------------------------------------------------------
# EXPENDITURE OVERVIEW & BAR CHART 
# ------------------------------------------------------------------------------

# df_hh <- subset(df_hh, HHExpenditure != 0)
library(unhcrthemes)

# df_hh <- subset(df_hh, HHExpenditure != 0)
average_HHExpenditure <- mean(df_hh$total_expenditure, na.rm = TRUE)
print(average_HHExpenditure)

library(ggplot2)

variables_to_average <- c("HHExp_FoodItems_1M", 
                          "HHExpNFRent_1M", 
                          "HHExpNFHyg_1M", 
                          "HHExpNFUtil_1M", 
                          "HHExpNFPhone_1M", 
                          "HHExpNFEdu_1M", 
                          "HHExpNFMedServ_1M", 
                          "HHExpNFDebt_1M",
                          "HHExpNFOther_1M",
                          "total_expenditure")

# Calculate the averages
averages <- sapply(df_hh[variables_to_average], mean, na.rm = TRUE)

# Create a data frame for plotting
averages_data <- data.frame(Variable = names(averages), Average = averages)
# Sort the data frame in descending order of averages
averages_data <- averages_data[order(averages_data$Average, decreasing = TRUE), ]

# Clean and simplify the labels
variable_labels <- c(
  "HHExp_FoodItems_1M" = "Food",
  "HHExpNFRent_1M" = "Rent",
  "HHExpNFHyg_1M" = "Hygiene",
  "HHExpNFUtil_1M" = "Utilities",
  "HHExpNFPhone_1M" = "Phone",
  "HHExpNFEdu_1M" = "Education",
  "HHExpNFMedServ_1M" = "Medical",
  "HHExpNFDebt_1M" = "Debt",
  "HHExpNFOther_1M" = "Other",
  "total_expenditure" = "Total"
)

# Create a simple bar chart
p <- ggplot(averages_data, aes(x = reorder(Variable, -Average), y = Average)) +
  geom_bar(stat = "identity", fill = unhcr_pal(n = 1, "pal_blue")) +
  # geom_text(aes(label = n), hjust = 0, nudge_x = 1) +
  geom_text(aes(label = round(Average, 2), vjust = -0.3, nudge_x = 2), size = 4) +  # Adjust nudge_y to lift labels higher
  labs(
    title = "Average Expenditure by Category in Bulgaria",
    subtitle = "Household Level",
    caption = "Including those who responded 0, but removing prefer not to respond"
  ) +
  theme_minimal() +
  scale_x_discrete(labels = variable_labels) +  # Use variable_labels for X-axis labels
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme_unhcr(legend_title = TRUE) +
  theme(legend.position = "none")  + # Remove the legend
  xlab(NULL) +  # Remove x-axis label
  ylab(NULL)    # Remove y-axis label

# Save the plot to a file with adjusted size for A4 page
ggsave("your_plot_Irma_UNHCR_Bulgaria_1.png", plot = p, width = 8.27, height = 5, units = "in", dpi = 300)


# ------------------------------------------------------------------------------
# % SHARE EXPENDITURE OVERVIEW & BAR CHART 
# ------------------------------------------------------------------------------

# Calculate the averages for share variables
share_variables <- c(
  "share_food_expenditure",
  "share_accomm_expenditure",
  "share_health_expenditure",
  "share_hygiene_expenditure",
  "share_communication_expenditure",
  "share_hh_bills_expenditure",
  "share_education_expenditure",
  "share_debt_expenditure",
  "share_other_expenditure"
)

averages_share <- sapply(df_hh[share_variables], mean, na.rm = TRUE)

# Create a data frame for plotting
averages_share_data <- data.frame(Variable = names(averages_share), Average = averages_share)

# Clean and simplify the labels
variable_labels <- c(
  "share_food_expenditure" = "Food",
  "share_accomm_expenditure" = "Accommodation",
  "share_health_expenditure" = "Health",
  "share_hygiene_expenditure" = "Hygiene",
  "share_communication_expenditure" = "Phone",
  "share_hh_bills_expenditure" = "Household Bills",
  "share_education_expenditure" = "Education",
  "share_debt_expenditure" = "Debt",
  "share_other_expenditure" = "Other"
)

# Sort the data frame in descending order of averages
averages_share_data <- averages_share_data[order(averages_share_data$Average, decreasing = TRUE), ]

# Create a simple bar chart
p_share <- ggplot(averages_share_data, aes(x = reorder(Variable, -Average), y = Average)) +
  geom_bar(stat = "identity", fill = unhcr_pal(n = 1, "pal_blue")) +
  geom_text(aes(label = paste0(round(Average * 100, 1), "%")), vjust = -0.3, nudge_x = 0, size = 4) +  # Adjust label position
  labs(
    title = "Average Share of Expenditure by Category in Bulgaria",
    subtitle = "Household Level",
    caption = "Including those who responded 0, but removing prefer not to respond"
  ) +
  theme_minimal() +
  scale_x_discrete(labels = variable_labels) +  # Use variable_labels for X-axis labels
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme_unhcr(legend_title = TRUE) +
  theme(legend.position = "none")  + # Remove the legend
  xlab(NULL) +  # Remove x-axis label
  ylab(NULL)    # Remove y-axis label

# Save the plot to a file with adjusted size for A4 page
ggsave("your_share_plot_Irma_UNHCR_Bulgaria.png", plot = p_share, width = 8.27, height = 5, units = "in", dpi = 300)


# ------------------------------------------------------------------------------
# PER CAPITA HOUSEHOLD EXPENDITURE
# ------------------------------------------------------------------------------

# Define the categories and corresponding labels
categories <- c(
  "HHExp_FoodItems_1M" = "Food",
  "HHExpNFRent_1M" = "Rent",
  "HHExpNFHyg_1M" = "Hygiene",
  "HHExpNFUtil_1M" = "Utilities",
  "HHExpNFPhone_1M" = "Phone",
  "HHExpNFEdu_1M" = "Education",
  "HHExpNFMedServ_1M" = "Medical",
  "HHExpNFDebt_1M" = "Debt",
  "HHExpNFOther_1M" = "Other",
  "HHExpenditure" = "Total"
)

# Create a function to calculate average income per capita
calculate_average_income_per_capita <- function(category, df) {
  average_per_capita <- mean(df[[category]] / df$HHSize, na.rm = TRUE)
  return(average_per_capita)
}

# Create a data frame for average income per capita
per_capita_data <- data.frame(Category = names(categories))
per_capita_data$AverageIncomePerCapita <- sapply(names(categories), function(category) {
  calculate_average_income_per_capita(category, df_hh)
}, simplify = "vector")

# Remove rows with NA values
per_capita_data <- per_capita_data[!is.na(per_capita_data$AverageIncomePerCapita), ]

# Sort the data frame in descending order of average income per capita
per_capita_data <- per_capita_data[order(per_capita_data$AverageIncomePerCapita, decreasing = TRUE), ]

# Create a simple bar chart
p <- ggplot(per_capita_data, aes(x = reorder(Category, -AverageIncomePerCapita), y = AverageIncomePerCapita)) +
  geom_bar(stat = "identity", fill = unhcr_pal(n = 1, "pal_blue")) +
  geom_text(aes(label = round(AverageIncomePerCapita, 2), vjust = -0.3, nudge_x = 2), size = 4) +
  labs(
    title = "Average Expenditure per Capita by Category in Bulgaria",
    subtitle = "Total Household Expenditure per Household Member",
    caption = "Including those who responded 0, but removing prefer not to respond"
  ) +
  theme_minimal() +
  scale_x_discrete(labels = categories) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme_unhcr(legend_title = TRUE) +
  theme(legend.position = "none") +
  xlab(NULL) +
  ylab(NULL)

# Save the plot to a file with adjusted size for A4 page
ggsave("average_income_per_capita_plot_3.png", plot = p, width = 8.27, height = 5, units = "in", dpi = 300)


 
################################################################################
### FINAL SAMPLE REMOVING MISSING VALUES FROM DEPENDENT VARIABLE - 801 (for logistics regression) - removed 18 where Vulnerability score is missing

df_hh <- subset(df_hh, vulnerability_log_2 != 2)
table(df_hh$vulnerability_log_2)


table(df_hh$dummy_older_persons)
table(df_hh$house_heating)
table(df_hh$outcome16_2_social_protection)


# Create a summary table
summary_table <- tapply(df_hh$HHExpenditure, df_hh$Max_coping_behaviourEN, FUN = mean)

# Print the summary table
print(summary_table)


# FOR MODELLING PURPOSES, IMPUTATION FOR EXPENDITURE DATA DOES NOT WORK WELL FOR FOR BULGARIA
# FIRSTLY, AFTER IMPUTING THE MEDIANS, THE AVERAGE TOTAL EXPDENDITURE IS VERY DIFFERENT FROM THE 
# SECONDLY, AFTER TESTING THE MODEL FIT IS BETTER AFTER REMOVING THE RESPONDENTS WITH THE MISSING TOTAL EXPENDITURE AMOUNTS (SAMPLE SIZE AROUND 750)

# IN ADDITION, THE INCOME VARIABLE IS REMOVED FROM THE ANALYSIS SINCE MORE THAN 70% OF RESPONDENTS HAVE INCOMPLETE DATA FOR THIS VARIABLE
# SO EVEN THOUGH IT'S SIGNIFICANT VARIABLE, THE NOISE INTRODUCED IN THE MODEL MIGHT CAUSE MORE ISSUES THAN IMPROVE IT

################################################################################
###  RUN LOGISTICS MODEL - FULL
################################################################################

# Convert variables to factors and set "yes" as the reference category
df_hh$outcome13_1_bank_account <- relevel(as.factor(df_hh$outcome13_1_bank_account), ref = "yes")
df_hh$impact3_3_safety_walking <- relevel(as.factor(df_hh$impact3_3_safety_walking), ref = "yes")
df_hh$outcome4_1_GBV <- relevel(as.factor(df_hh$outcome4_1_GBV), ref = "yes")
df_hh$outcome13_2_income <- relevel(as.factor(df_hh$outcome13_2_income), ref = "yes")
df_hh$outcome16_2_social_protection <- relevel(as.factor(df_hh$outcome16_2_social_protection), ref = "yes")

table(df_hh$accommodation_arrangement)


df_hh$household_head_edu_level <- relevel(as.factor(df_hh$household_head_edu_level), ref = "tech")
df_hh$accommodation_type <- relevel(as.factor(df_hh$accommodation_type), ref = "state_programme")
df_hh$accommodation_arrangement <- relevel(as.factor(df_hh$accommodation_arrangement), ref = "no_payment_free")


table(df_hh$outcome16_2_social_protection) # very small sample reporting receiving social assistance 


table(df_hh$accommodation_type)


# CHECK THE DIFFERENT IN RESULTS WHEN RUNNING THE MODEL FOR DIFFERENT ACCOMMODATION TYPES
df_hh_state_programme <- subset(df_hh, accommodation_type == "state_programme")   # sample 343 observations - state program and hotel / hostel
view(df_hh_state_programme)

num_rows <- nrow(df_hh_state_programme)
print(num_rows)

# CHECK THE DIFFERENT IN RESULTS WHEN RUNNING THE MODEL FOR DIFFERENT ACCOMMODATION TYPES
df_hh_own_accommodation <- subset(df_hh, accommodation_type == "own_accommodation") # sample 320 observations - own accommodation / shared (outside state programme) 
num_rows <- nrow(df_hh_own_accommodation)
print(num_rows)

# Fit a logistic regression model - FULL MODEL 
model1 <- glm(vulnerability_log_2 ~ hh_size + 
                                    household_head_age + 
                                    household_head_edu_level + 
                                    household_head_gender + 
                                    arrival_number_months + 
                                    total_income_sum +
                                    income_source_none + 
                                    social_protection +
                                    income_source_employement_host + 
                                    dummy_single_female_head + 
                                    dummy_adult_employment_contract +
                                    dummy_health_issues + 
                                    dummy_chronic_illness + 
                                    dummy_psychological_issue + 
                                    dummy_older_persons +
                                    disability_dummy + 
                                    child_dummy  + 
                                    rural_urban + 
                                    accommodation_type +
                                    accommodation_arrangement + 
                                    accommodation_duration + 
                                    living_conditions_issues +
                                    outcome13_1_bank_account +  
                                    impact3_3_safety_walking + 
                                    outcome4_1_GBV + 
                                    outcome13_2_income + 
                                    outcome16_2_social_protection + 
                                    local_hostility  + 
                                    priority_need_none + 
                                    priority_need_food + 
                                    priority_need_accommodation + 
                                    priority_need_employment + 
                                    priority_need_healthcare +
                                    priority_need_language_courses +
                                    priority_need_childcare + 
                                    priority_need_medicines + 
                                    emergency_coping_EN +
                                    rCSI, data = df_hh, family = "binomial")



# Summarize the model
summary(model1)

# Extract design matrix from the model
X <- model.matrix(model1)

# Summarize the model
model_summary1 <- summary(model1)


# Extract the coefficients table from the model summary
coefficients_table <- as.data.frame(model_summary1$coefficients)

# Add a column for variable names
coefficients_table$Variable <- rownames(coefficients_table)

# Define the path and filename for the Excel file
output_excel_file <- "logistic_regression_summary_full.xlsx"

# Export the coefficients table to an Excel file
writexl::write_xlsx(coefficients_table, path = output_excel_file)



# ------------------------------------------------------------------------------
# REDUCED MODEL: (ONLY SIGNIFICANT VARIABLES) -  
# ------------------------------------------------------------------------------

# Fit a logistic regression model - REDUCED MODEL
model2 <- glm(vulnerability_log_2 ~ hh_size +
                                    household_head_age + 
                                    household_head_edu_level +
                                    dummy_single_female_head + 
                                    income_source_employement_host + 
                                    dummy_psychological_issue + 
                                    child_dummy +
                                    accommodation_type +
                                    accommodation_arrangement +
                                    priority_need_childcare + 
                                    rCSI, data = df_hh, family = "binomial")


# Summarize the model
summary(model2)


# Summarize the model
model_summary1 <- summary(model2)

# Extract the coefficients table from the model summary
coefficients_table <- as.data.frame(model_summary1$coefficients)

# Add a column for variable names
coefficients_table$Variable <- rownames(coefficients_table)

# Define the path and filename for the Excel file
output_excel_file <- "logistic_regression_summary_reduced.xlsx"

# Export the coefficients table to an Excel file
writexl::write_xlsx(coefficients_table, path = output_excel_file)


# Extract design matrix from the model
#X <- model.matrix(model2)

# Calculate VIF
#vif_values <- car::vif(model2)
#print(vif_values)



################################################################################
###  ODDS RATIOS 
################################################################################


# Extract the coefficient estimates from the model
coef_estimates <- coef(model2)

# Extract the standard errors for the coefficients
std_errors <- summary(model2)$coef[, "Std. Error"]

# Calculate the odds ratios and their confidence intervals
odds_ratios <- exp(coef_estimates)
lower_ci <- exp(coef_estimates - 1.96 * std_errors)
upper_ci <- exp(coef_estimates + 1.96 * std_errors)

# Create a data frame to display the results
odds_ratio_table <- data.frame(
  Variable = names(coef_estimates),
  Odds_Ratio = odds_ratios,
  Lower_CI = lower_ci,
  Upper_CI = upper_ci
)

# Print the odds ratio table
print(odds_ratio_table)

write_xlsx(odds_ratio_table, path = "logistics_regression_odds_ratio_table_reduced.xlsx")



# ------------------------------------------------------------------------------
# ------------------------------------------------------------------------------
# MULTIPLE LINEAS REGRESSION:  EXPENDITURE OUTCOME VARIABLE
# ------------------------------------------------------------------------------
# ------------------------------------------------------------------------------


# INCOME SOURCES 

reg_model1 <- lm(total_expenditure ~ 
                   hh_size +
                   household_head_age + 
                   household_head_edu_level + 
                   household_head_gender + 
                   arrival_number_months + 
                   rural_urban + 
                   income_source_none + 
                   income_source_soc_protection_host + 
                   income_source_soc_protection_ukr + 
                   income_source_employement_host + 
                   dummy_single_female_head + 
                   dummy_adult_employed +
                   dummy_health_issues + 
                   dummy_chronic_illness + 
                   dummy_psychological_issue + 
                   dummy_pregnant_breastfeeding + 
                   dummy_older_persons +
                   disability_dummy + 
                   child_dummy  + 
                   accommodation_type +
                   accommodation_arrangement +
                   accommodation_duration + 
                   living_conditions_issues + 
                   outcome13_1_bank_account +  
                   impact3_3_safety_walking + 
                   outcome4_1_GBV + 
                   outcome13_2_income + 
                   outcome16_2_social_protection + 
                   local_hostility  + 
                   priority_need_food + 
                   priority_need_accommodation + 
                   priority_need_employment + 
                   priority_need_healthcare +
                   priority_need_language_courses +
                   priority_need_childcare +
                   priority_need_medicines +
                   stress_coping_EN  +
                   crisis_coping_EN +
                   emergency_coping_EN +
                   rCSI, data = df_hh)


# Summarize the model
summary(reg_model1)
model_summary <- summary(reg_model1)


# OUTPUT to EXCEL FILE 

# Define the path and file name for the Excel file
output_excel_file <- "linear_regression_summary_1_full.xlsx"

# Extract the coefficients table from the summary
coefficients_table <- model_summary$coefficients

# Create a data frame with variable names and significance levels
coefficients_df <- data.frame(
  Variable = rownames(coefficients_table),
  Coefficient = coefficients_table[, 1],
  Std.Error = coefficients_table[, 2],
  t.value = coefficients_table[, 3],
  Pr.Value = coefficients_table[, 4]
)

# Export the coefficients data frame to an Excel file
writexl::write_xlsx(coefficients_df, path = output_excel_file)



# INCOME SOURCES 

reg_model_check <- lm(total_expenditure ~ 
                   hh_size +
                   dummy_psychological_issue + 
                   child_dummy  + 
                   accommodation_type +
                   accommodation_arrangement +
                   outcome13_1_bank_account +  
                   priority_need_food + 
                   priority_need_employment + 
                   emergency_coping_EN  +
                   rCSI, data = df_hh)


# Summarize the model
summary(reg_model_check)
model_summary <- summary(reg_model_check)



### ----------------------------------------------------------------------------
###          REDUCED MODEL - ONLY SIGNIFICANT VARIABLES
### ----------------------------------------------------------------------------


reg_model2 <- lm(total_expenditure ~ 
                   hh_size +
                   dummy_psychological_issue + 
                   accommodation_type + 
                   accommodation_arrangement + 
                   accommodation_duration +
                   outcome13_1_bank_account +
                   priority_need_food + 
                   priority_need_employment + 
                   emergency_coping_EN +
                   rCSI, data = df_hh)


# Summarize the model
summary(reg_model2)
model_summary <- summary(reg_model2)


# Define the path and file name for the Excel file
output_excel_file <- "linear_regression_summary_2_reduced.xlsx"

# Extract the coefficients table from the summary
coefficients_table <- model_summary$coefficients

# Create a data frame with variable names and significance levels
coefficients_df <- data.frame(
  Variable = rownames(coefficients_table),
  Coefficient = coefficients_table[, 1],
  Std.Error = coefficients_table[, 2],
  t.value = coefficients_table[, 3],
  Pr.Value = coefficients_table[, 4]
)

# Export the coefficients data frame to an Excel file
writexl::write_xlsx(coefficients_df, path = output_excel_file)






### ----------------------------------------------------------------------------
###          TEST!!!!
### ----------------------------------------------------------------------------


df_hh <- df_hh %>%
  mutate(sum_employed = case_when(
    sum_employed > 1 ~ "2+",
    TRUE ~ as.character(sum_employed) # Convert sum_employed to character
  ))


df_hh_income <- subset(df_hh, total_income_sum >= 100 & total_income_sum < 9000)

# Count rows in df_hh_income
row_count <- nrow(df_hh_income)
print(row_count) # total 242 observations


reg_model_test <- lm(total_expenditure ~ 
                   hh_size +
                   sum_employed, data = df_hh)



# Install and load the car package if not already installed
#install.packages("car")
library(car)

# Check VIF for multicollinearity
vif_test <- vif(reg_model_test)
print(vif_test)

# Summarize the model
summary(reg_model_test)
model_summary <- summary(reg_model_test)


# Define the path and file name for the Excel file
output_excel_file <- "linear_regression_summary_employment.xlsx"

# Extract the coefficients table from the summary
coefficients_table <- model_summary$coefficients

# Create a data frame with variable names and significance levels
coefficients_df <- data.frame(
  Variable = rownames(coefficients_table),
  Coefficient = coefficients_table[, 1],
  Std.Error = coefficients_table[, 2],
  t.value = coefficients_table[, 3],
  Pr.Value = coefficients_table[, 4]
)

# Export the coefficients data frame to an Excel file
writexl::write_xlsx(coefficients_df, path = output_excel_file)




